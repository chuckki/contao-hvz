var rabatt = 0;


$(document).ready(function() {


    $('#submit').on('click', function() {
        var hvz = $("input[name=Genehmigung][type=radio]:checked");
        if(hvz.length){
            setPrice(hvz.data('price'),hvz.val(), hvz.data('hvztyp'),1);
        }
    });


    // *****************************
    // get Rabatt
    lookupRabatt();
    $("#ctrl_122").on( "keyup blur change", function() {
        lookupRabatt();
    });
    function lookupRabatt(){
        var str = $("#ctrl_122").val();
        if (str.length == 0) {
            rabatt = 0;
            return;
        } else {
            var xmlhttp;
            if (window.XMLHttpRequest){// code for IE7+, Firefox, Chrome, Opera, Safari
                xmlhttp=new XMLHttpRequest();
            }else{// code for IE6, IE5
                xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            }
            xmlhttp.onreadystatechange = function() {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    rabatt = xmlhttp.responseText;
                    $('input[name=Rabatt][type=hidden]').val(rabatt);
                    if(rabatt != 0){
                        renderPreisWithRabat(rabatt);
                    }else{
                        renderPreisWithRabat(rabatt);
                    }
                }
            }
            xmlhttp.open("GET", "/rabatt/" + str, true);
            xmlhttp.send();
        }
    }

    // *****************************
    // scroll to Bestellung from top menu
    $(".searchicon").click(function() {
        scrollToAnchor('bestellung');
        return false;
    });

    // *****************************
    // vom-Datum for datepicker
    $('#ctrl_53').click(function(e){e.preventDefault();});


    // *****************************
    // set icons
    $("label.car").append('<i class="fa fa-car" ></i>');
    $("label.lkw").append('<i class="fa fa-truck" ></i>');
    $("label.male").append('<i class="fa fa-male" ></i>');
    $("label.female").append('<i class="fa fa-female" ></i>');
    $("body").append('<img style="display:none;" src="/files/halteverbot-theme/img/loading32x32.gif" />');


    // *****************************
    // hide genehmigung ist vorhanden
    $( "fieldset.gotgen" ).hide();

    $('#opt_64_0').change( function() {
        $('fieldset.gotgen').hide();
    });
    $('#opt_64_1').change( function() {
        $('fieldset.gotgen').hide();
    });
    $('#opt_64_3').change( function() {
        $('fieldset.gotgen').show();
    });
    $('#opt_64_4').change( function() {
        $('fieldset.gotgen').show();
    });

    // *****************************
    // handle grund
    $('#ctrl_247').change( function() {
        var selVal = $(this).val();
        if( selVal == 'baustelle' || selVal == 'containergestellung'){
            $('#grundAddon').show();
            $('#grundSonstig').hide();
        }else{
            if(selVal == 'sonstiges'){
                $('#grundAddon').hide();
                $('#grundSonstig').show();
            }else{
                $('#grundAddon').hide();
                $('#grundSonstig').hide();
            }
        }
    });

    // *****************************
    // handle firma => umst
    $('#umstElement').hide();
    $('#ctrl_72').on('input', function() {
        var selVal = $(this).val();
        if( selVal != '' ){
            $('#umstElement').show();
        }else{
            $('#umstElement').hide();
        }
    });


    // *****************************
    // click on Ort => goto serach page
    $( "input.disabledOrt" ).click(function() {
        var r = confirm('Möchten Sie einen anderen Ort?');
        if (r == true) {
            window.location.href= "/halteverbotszone-bestellen.html?search=true";
        } else {
        }
    });

    // *****************************
    // handel Radio Lables
    $('#fahrzeug input').change( function() {
        $(this).parent().parent().children().not().removeClass('selectedRadio');
        $(this).parent().addClass('selectedRadio');
    });
    $('#genehmigung input').change( function() {
        $(this).parent().parent().children().not().removeClass('selectedRadio');
        $(this).parent().addClass('selectedRadio');
    });
    $('#gender input').change( function() {
        $(this).parent().parent().children().not().removeClass('selectedRadio');
        $(this).parent().addClass('selectedRadio');
    });


    // *****************************
    // handle resizing window
    $(window).on('resize', function(){
        CheckWindow($(this));
    });

    function CheckWindow(win){
        if ($(window).width() < 790) {
            if(!$(".searchicon").length){
                $(".logo").append('<div class="searchicon fa fa-pencil fa-3x" ontouchstart="return true;" ></div>');
                $(".searchicon").click(function() {
                    scrollToAnchor('bestellung');
                    return false;
                });
            };
        }else{
            $(".searchicon").remove();
        };
    }

    CheckWindow($(window));


    // *****************************
    // validate Form

    var errorIcon = '<i class="fa fa-exclamation-triangle"></i>';
    $('#submit').click(function(e) {
        $("span.error").remove();
        var scroll2Error = "";
        scrollTarget = validateHVZ();
        scroll2Error = (scroll2Error == "") ? scrollTarget: scroll2Error;
        scrollTarget = validateAdresseHVZ();
        scroll2Error = (scroll2Error == "") ? scrollTarget : scroll2Error;
        scrollTarget = validateTimeHVZ();
        scroll2Error = (scroll2Error == "") ? scrollTarget : scroll2Error;
        scrollTarget = validateDetailsHVZ();
        scroll2Error = (scroll2Error == "") ? scrollTarget : scroll2Error;

        if($('#halteverbot-anfrage').length == 0){
            scrollTarget = validateRechnungsAdresse('bestellung');
            scroll2Error = (scroll2Error == "") ? scrollTarget : scroll2Error;
            scrollTarget = validateAGB();
            scroll2Error = (scroll2Error == "") ? scrollTarget : scroll2Error;
        }else{
            scrollTarget = validateRechnungsAdresse('anfrage');
            scroll2Error = (scroll2Error == "") ? scrollTarget : scroll2Error;
            var anzahlTag = parseInt($("#ctrl_54").val());
            $('input[name=bis]').val(computeDate(picker,anzahlTag)[0]);
        };


        if(scroll2Error != ""){
            scrollToAnchor(scroll2Error);
            e.preventDefault();
        }else{
            if($('#halteverbot-anfrage').length == 0){
                $data = {
                    autoCheck: false,
                    size: 32,
                    bgColor: '#fff',
                    bgOpacity: 0.7,
                    fontColor: '#263777',
                    title: 'Bestellung wird verarbeitet'
                };
            }else{
                $data = {
                    autoCheck: false,
                    size: 32,
                    bgColor: '#fff',
                    bgOpacity: 0.7,
                    fontColor: '#263777',
                    title: 'Anfrage wird verarbeitet'
                };
            }

            $.loader.open($data);
        };
    });

    function validateAGB(){
        var myAGB = $('input[name=agbakzeptiert][type=hidden]');
        if ($("input[name=agbakzeptiert]:checked").length == 0){
            $(myAGB).before('<span class="error">' +errorIcon+'Bitte akzeptieren Sie unsere AGB.</span>');
            isValid = false;
        }
        if(!isValid){
            return "agb";
        }
        return "";
    }

    function validateRechnungsAdresse(typ){
        var isValid = true;

        var myName = $('input[name=Name]');
        var mymail = $('input[name=email]');
        if($(myName).val() == ""){
            $(myName).before('<span class="error">' +errorIcon+'Bitte geben Sie Ihren Namen an.</span>');
            isValid = false;
        }
        if($(mymail).val() == "" || !checkEmail((mymail).val())){
            $(mymail).before('<span class="error">' +errorIcon+'Bitte geben Sie eine gültige E-Mail-Adresse an.</span>');
            isValid = false;
        }
        if ($("input[name=Geschlecht]:checked").length == 0){
            $('#gender').before('<span class="error">' +errorIcon+'Bitte geben Sie Ihr Geschlecht an.</span>');
            isValid = false;
        }

        var mytel = $('input[name=Telefon]');
        if(typ=='bestellung'){
            var myVorname = $('input[name=Vorname]');
            var mystreet = $('input[name=strasse_rechnung]');
            var myOrt = $('input[name=ort_rechnung]');
            if($(myVorname).val() == ""){
                $(myVorname).before('<span class="error">' +errorIcon+'Bitte geben Sie Ihren Vornamen an.</span>');
                isValid = false;
            }
            if($(mystreet).val() == ""){
                $(mystreet).before('<span class="error">' +errorIcon+'Bitte geben Sie die Straße mit Hausnummer an.</span>');
                isValid = false;
            }else{
                if(!$(mystreet).val().match(/[0-9]/)){
                    $(mystreet).before('<span class="error">' +errorIcon+'Geben Sie zu der Straße auch eine Hausnummer an.</span>');
                    isValid = false;
                }
            }

            if($(myOrt).val() == ""){
                $(myOrt).before('<span class="error">' +errorIcon+'Bitte geben Sie einen Ort mit dazugehöriger Postleitzahl an.</span>');
                isValid = false;
            }else{
                if(!$(myOrt).val().match(/[0-9]{5}/)){
                    $(myOrt).before('<span class="error">' +errorIcon+'Bitte geben Sie eine Postleitzahl mit zum Ort an.</span>');
                    isValid = false;
                }
            }
        }
        if($(mytel).val() == "" || $(mytel).val().match(/[a-zA-Z]/) ){
            $(mytel).before('<span class="error">' +errorIcon+'Bitte geben Sie eine Telefonnumer an, unter der wir Sie tagüber erreichen können.</span>');
            isValid = false;
        }
        if(!isValid){
            return (typ=='bestellung') ? "rechnungsadresse" : "kontakt";
        }
        return "";
    }

    function checkEmail(x) {
        var atpos = x.indexOf("@");
        var dotpos = x.lastIndexOf(".");
        if (atpos< 1 || dotpos<atpos+2 || dotpos+2>=x.length) {
            return false;
        }else{
            return true;
        }
    }

    function validateDetailsHVZ(){
        isValid = true;

        var foundMe = $( "select[name=Grund] option:selected" ).text()
        var arr = ["Umzug", "Containergestellung", "Baustelle","Sonstiges" ];
        if ($.inArray(foundMe, arr) == -1){
            $("#grund").before('<span class="error">' +errorIcon+'Bitte wählen Sie den Grund für Ihre Halteverbotszone.</span>');
            isValid = false;
        }


        if ($("input[name=Fahrzeug]:checked").length == 0){
            $('#fahrzeug').before('<span class="error">' +errorIcon+'Bitte wählen aus, für welche Fahrzeugart die Halteverbotszone eingerichtet werden soll.</span>');
            isValid = false;
        }

        if(!isValid){
            return "hvzDetails";
        }
        return "";
    }

    function validateTimeHVZ(){
        var mytime = $('input[name=vom]').val();
        isValid = true;
        if(mytime == "" || !gueltigesDatum(mytime)){
            $('.mydate .date1').before('<span class="error">' +errorIcon+'Bitte wählen ein Datum für die Aufstellung aus. <i>Format: tt.mm.jjjj</i></span>');
            isValid = false;
        }
        if(!isValid){
            return "hvzDatum";
        }
        return "";
    }

    function gueltigesDatum (datum){
        if (!datum) return false;
        datumArray=datum.split(".");
        if (datumArray.length!=3) return false;
        datumArray[0]=parseInt(datumArray[0],10);
        datumArray[1]=parseInt(datumArray[1],10)-1;
        datumArray[2]=parseInt(datumArray[2],10);
        var kontrolldatum=new Date(datumArray[2],datumArray[1],datumArray[0]);

        if (kontrolldatum.getDate()==datumArray[0] && kontrolldatum.getMonth()==datumArray[1]){
            return true;
        }
        return false;
    }

    function validateAdresseHVZ(){
        var myort = $('input[name=Ort]');
        var myplz = $('input[name=PLZ]');
        var mystreet = $('input[name=Strasse]');
        isValid = true;
        if($(myort).val() == ""){
            $(myort).before('<span class="error">' +errorIcon+'Bitte wählen Sie den Ort für die Halteverbotszone aus.</span>');
            isValid = false;
        }
        if($(myplz).val() == ""){
            $(myplz).before('<span class="error">' +errorIcon+'Bitte wählen Sie die dazugehörige Postleitzahl aus.</span>');
            isValid = false;
        }else{
            var land =  $('input[name=hvzLand]');
            if($(land).val() != 'Deutschland'){
                if(!$(myplz).val().match(/[0-9]{4}/)){
                    $(myplz).before('<span class="error">' +errorIcon+'Bitte geben Sie eine gültige Postleitzahl an.</span>');
                    isValid = false;
                }
            }else{
                if(!$(myplz).val().match(/[0-9]{5}/)){
                    $(myplz).before('<span class="error">' +errorIcon+'Bitte geben Sie eine gültige Postleitzahl an.</span>');
                    isValid = false;
                }
            }
        }
        if($(mystreet).val() == ""){
            $(mystreet).before('<span class="error">' +errorIcon+'Bitte geben Sie eine Straße mit Hausnummer an.</span>');
            isValid = false;
        }else{
            if(!$(mystreet).val().match(/[0-9]/)){
                $(mystreet).before('<span class="error">' +errorIcon+'Bitte geben Sie zur Straße eine Hausnummer mit an.</span>');
                isValid = false;
            }
        }
        if(!isValid){
            return "hvzAdresse";
        }
        return "";
    }

    function validateHVZ(){
        if ($("input[name=Genehmigung]:checked").length == 0){
            $('#hvzProdukt').prepend('<span class="error">' +errorIcon+'Bitte wählen Sie eine Halteverbotszone aus.</span>');
            return "hvzProdukt";
        }
        return "";
    }

});

// *****************************
// handle date

$('.mydate .date2 select').change( function() {
    updatePreis();
});

function renderPreisWithRabat(value){
    if($('.rabattInfo').length == 0){
        $('.gutscheinRow').after( '<p class="rabattInfo">Mit dem von Ihnen eingegeben Gutscheincode erhalten Sie <strong>'+parseInt(value)+'% Rabatt</strong></p>' );
    }else{
        $('.rabattInfo strong').text(+parseInt(value)+'% Rabatt');
    };
    $('#hvzPreis').insertAfter($('.rabattInfo'));
    if($('.sumNetto').length == 0){
        $('.tagPreis').after( '<tr class="sumBrutto"><td><strong>Zwischensumme</strong> <small>(19% MwSt enthalten)</small></td><td class="bruttoValue"></td></tr><tr><td>&nbsp;</td><td>&nbsp;</td></tr><tr class="sumNetto"><td>Preis ohne 19% Mehrwertsteuer</td><td class="nettoValue"></td></tr><tr class="showRabatt"><td class="rabValue">- '+parseInt(value)+'% Rabatt</td><td class="rabattValue"></td></tr><tr class="sumNettoWithRabatt"><td>Zwischensumme</td><td class="nettoRabattValue"></td></tr><tr class="MwstNettoWithRabatt"><td>19% Mehrwertsteuer</td><td class="mwst"></td></tr>');
    }
    updatePreis();
}


function getNameOfDay(mydate){
    var d = new Date(mydate);
    var weekday = new Array("Sonntag","Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag");
    return weekday[d.getDay()];
}

function roundTo2(value){
    return parseFloat( parseFloat(value.toFixed(3)).toFixed(2) );
}
function getRoundMwst(value){
    var myret =  roundTo2((value/119)*100);
    return myret;
}
function setRoundMwst(value){
    var myret =  roundTo2(value*0.19);
    return myret;
}

function setPrice(hvzPreis, hvzName,hvzType, submit = 0){
    $('input[name=type][type=hidden]').val(hvzType);
    if ($('#setprice').val() == 0 && hvzPreis == 0){
        return true;
    };
    $('#setprice').val(hvzPreis);
    var text = '<h3>Preis für das Halteverbot in '+ $('input[name=Ort]').val() + '</h3><p class="desc"></p>';
    text +='<table><tr><td class="hvzName">' + hvzName + '</td><td class="hvzPreis"></td></tr><tr class="tagPreis"><td class="tageDesc"></td><td class="tagePreis"></td></tr><tr class="sumPreis"><td><strong>Endpreis</strong> <small>(19% MwSt enthalten)</small></td><td class="gesamtPreis"></td></tr></table>';

    if($('#hvzPreis').length == 0){
        $("#hvzDetails").before('<div id="hvzPreis" class="formRow">' + text + '</div>');
    }else{
        $('#hvzPreis').html(text);
    }

    if(submit == 0){
        switch(hvzType) {
            case 1:
            case 2:
                setNewStart(7);
                break;
            case 3:
            case 4:
                setNewStart(5);
                break;
        }
    }

    if($('#ctrl_122').val() != ""){
        renderPreisWithRabat(rabatt);
    }else{
        updatePreis();
    }
}


function updatePreis(){
    if($('#setprice').val() != 0){
        var anzahlTag = parseInt($("#ctrl_54").val());
        var descTage = (anzahlTag > 1) ? 'Tage' : 'Tag';
        $('input[name=bis]').val(computeDate(picker,anzahlTag)[0]);
        $("#hvzPreis .desc").html('vom ' + getNameOfDay(picker) + ' den ' +$("#ctrl_53").val() + ' bis einschließlich ' + computeDate(picker,anzahlTag)[1] + ' den ' + computeDate(picker,anzahlTag)[0] + ' ('+anzahlTag+' '+descTage+')');
        var hvzPreis = parseInt($('#setprice').val());
        var kostenProTag = parseInt($(".preisEt").text());
        $('input[name=hvzTagesPreis][type=hidden]').val(kostenProTag);

        if($('#ctrl_122').val() == ""){
            // ohne Rabatt
            $(".hvzPreis").text(hvzPreis.toFixed(2) + ' €');
            var descTage = ((anzahlTag-1) > 1 || (anzahlTag-1) == 0) ? 'Tage' : 'Tag';
            $(".tageDesc").text('Zuschlag für Zusatztag pro Tag '+ kostenProTag +' € x ' + (anzahlTag-1) +' '+ descTage);
            $(".tagePreis").text(((anzahlTag-1)*kostenProTag).toFixed(2) + " €");
            var gesamt = ((anzahlTag-1)*kostenProTag)+hvzPreis;
            $('input[name=gesamtPreis][type=hidden]').val(gesamt.toFixed(2));
            $('input[name=EndPreis][type=hidden]').val(gesamt.toFixed(2));
            $(".gesamtPreis").html("<strong>" + gesamt.toFixed(2) + " € </strong>");
            var mwst = setRoundMwst(gesamt/100*119);
            $('input[name=PreisMwSt][type=hidden]').val(mwst.toFixed(2));
        }else{
            // mit Rabatt
            hvzPreis = (hvzPreis);
            kostenProTag = (kostenProTag);
            $(".hvzPreis").text(hvzPreis.toFixed(2) + ' €');
            var descTage = ((anzahlTag-1) > 1 || (anzahlTag-1) == 0) ? 'Tage' : 'Tag';
            $(".tageDesc").text('Zuschlag für Zusatztag pro Tag '+ kostenProTag +' € x ' + (anzahlTag-1) +' '+ descTage);
            $(".tagePreis").text('+ ' + ((anzahlTag-1)*kostenProTag).toFixed(2) + " €");

            var bruttoValue = roundTo2(((anzahlTag-1)*kostenProTag)+hvzPreis);
            $(".bruttoValue").html("<strong>" + bruttoValue.toFixed(2) + " €</strong>");
            $('input[name=EndPreis][type=hidden]').val(bruttoValue.toFixed(2));
            var summeNetto = roundTo2(bruttoValue/119*100);
            $(".nettoValue").text(summeNetto.toFixed(2) + " €");

            $(".rabValue").text(parseInt(rabatt)+'% Rabatt');

            var rabattValue = roundTo2(summeNetto/100*parseInt(rabatt));
            $(".rabattValue").text('- ' + rabattValue.toFixed(2) + " €");
            var nettoRabattValue = roundTo2(summeNetto - rabattValue);
            $(".nettoRabattValue").text(nettoRabattValue.toFixed(2) + " €");
            var mwst = setRoundMwst(nettoRabattValue);
            $(".mwst").text('+ ' + mwst.toFixed(2) + " €");
            $('input[name=PreisMwSt][type=hidden]').val(mwst.toFixed(2));

            var gesamt = roundTo2(mwst + nettoRabattValue);
            $('input[name=gesamtPreis][type=hidden]').val(gesamt);
            $(".gesamtPreis").html("<strong>" + gesamt.toFixed(2) + " € </strong>");

        }
    }
}


function computeDate(start, n){
    var targetDate = start.getDate();
    targetDate.setDate(targetDate.getDate() + (parseInt(n)-1) );
    var res = new Array(2);
    res[0] = ('0' + targetDate.getDate()).slice(-2) + '.' + ('0' + (targetDate.getMonth()+1)).slice(-2) + '.' + targetDate.getFullYear();
    res[1] = getNameOfDay(targetDate);
    return res;
}


var thisyear = new Date().getFullYear();
var startdate = new Date();
startdate.setDate(startdate.getDate() + 7);


function setNewStart(n){
    var thisyear = new Date().getFullYear();
    var startdate = new Date();
    startdate.setDate(startdate.getDate() + n -1);
    picker.setMinDate(startdate);
    var startdate = new Date();
    startdate.setDate(startdate.getDate() + n);
    //picker.setDate(startdate);
}

var picker = new Pikaday ({
    firstDay: 1, // 1 = Montag
    defaultDate: startdate,
    setDefaultDate: true,
    field: document.getElementById('ctrl_53'),
    minDate: startdate,
    maxDate: new Date(thisyear+1 + '-12-31'),
    i18n: {
        previousMonth : 'vorheriger Monat',
        nextMonth     : 'nächster Monat',
        months        : ['Januar','Februar','März','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'],
        weekdays      : ['Sonntag','Montag','Dienstag','Mittwoch','Donnerstag','Freitag','Samstag'],
        weekdaysShort : ['So','Mo','Di','Mi','Do','Fr','Sa']
    },
    onSelect: function(date) {
        isDate4Preis = true;
        updatePreis();
    }
});


/*
 * $.loader.open(arg); 打开屏幕菊花
 */
(function ($) {
    $.loader_ext = {
        defaults: {
            autoCheck: 32,
            css: {},
            size: 16,
            bgColor: '#FFF',
            bgOpacity: 0.5,
            fontColor: false,
            position: [0, 0, 0, 0],
            title: '',
            isOnly: true,
            imgUrl: '/files/halteverbot-theme/img/loading32x32.gif',
            onShow: function () {
            },
            onClose: function () {
            }
        },

        template: function (tmpl, data) {
            $.each(data, function (k, v) {
                tmpl = tmpl.replace('${' + k + '}', v);
            });
            return $(tmpl);
        },

        init: function (scope, options) {
            this.options = $.extend({}, this.defaults, options);
            this.scope = scope;

            if (this.scope.is(':hidden')) {
                return;
            }
            this.checkScope();
            this.check_position();
            this.check_unique();
            this.create();
            this.set_css();
            this.set_define();
            this.show();

            return this.loading;
        },

        checkScope: function () {
            if (!this.options.autoCheck) {
                return;
            }
            if (this.scope.is('body') || this.scope.is('div') || this.scope.is('form')) {
                this.options.size = this.options.autoCheck;
            }
            if (this.scope.is('input') || this.scope.is('button')) {
                this.options.title = '';
            }
        },

        check_position: function () {
            var pos = this.options.position;
            for (var i = 0; i < 4; i++) {
                if (pos[i] === undefined) {
                    pos[i] = 0;
                }
            }
            this.options.position = pos;
        },

        check_unique: function () {
            if (this.options.isOnly && this.loading !== undefined) {
                this.close();
            }
        },

        create: function () {
            var ops = this.options;
            ops.imgUrl = ops.imgUrl.replace('[size]', ops.size + 'x' + ops.size);
            this.loading = this.template($.loader.tmpl, {
                Class: 'x' + ops.size,
                Src: ops.imgUrl,
                Title: ops.title
            }).hide();
            this.loading.appendTo($('body'));
        },

        set_css: function () {
            var scope = this.scope,
                ops = this.options,
                loading = this.loading,
                height = scope.outerHeight(),
                width = scope.outerWidth(),
                top = scope.offset().top,
                left = scope.offset().left;

            loading.css('top', top);

            if (scope.is('body')) {
                height = $(window).height();
                width = $(window).width();
                loading.css('position', 'fixed');

                this.for_ie6();
            }

            loading.css({
                'height': height + ops.position[2],
                'width': width + ops.position[3],
                'left': left,
                'border-radius': scope.css('border-radius')
            }).css(ops.css);

            var loader = loading.children();
            loader.css({
                'margin-top': (height - ops.size) / 2 + ops.position[0],
                'margin-left': (width - ops.size) / 2 + ops.position[1] - loader.find('span').outerWidth() / 2
            });
        },

        set_define: function () {
            var ops = this.options,
                loading = this.loading;
            if (!ops.bgColor) {
                loading.css('background', 'none');
            } else {
                loading.css({
                    'background-color': ops.bgColor,
                    'opacity': ops.bgOpacity,
                    'filter': 'alpha(opacity=' + ops.bgOpacity * 100 + ')'
                });
            }

            ops.fontColor && loading.find('span').css('color', ops.fontColor);

            var self = this;
            $(window).resize(function () {
                self.loading && self.set_css();
            })
        },

        for_ie6: function () {
            var loading = this.loading;
            if ($.browser && $.browser.msie && $.browser.version == '6.0') {
                loading.css({
                    'position': 'absolute',
                    'top': $(window).scrollTop()
                });

                $(window).scroll(function () {
                    loading.css("top", $(window).scrollTop());
                })
            }
        },

        show: function () {
            var ops = this.options;
            this.loading.show(1, function () {
                var loader = $(this).children();
                var left = loader.css('margin-left').replace('px', '');
                loader.css('margin-left', left - loader.find('span').outerWidth() / 2);
                ops.onShow(this.loading);
            });
        },

        close: function (all) {
            if (all) {
                var className = $($.loader.tmpl).attr('class');
                $('.' + className).remove();
            } else {
                if (this.loading != undefined) {
                    this.loading.remove();
                    this.loading = undefined;
                }
            }
            this.options != undefined && this.options.onClose();
        }
    };

    $.loader = {
        tmpl: '<div class="loading_wrp"><div class="loading ${Class}"><img src="${Src}" /><span>${Title}</span></div></div>',

        open: function (arg) {
            return $('body').loader(arg);
        },
        close: function (all) {
            $.loader_ext.close(all);
        }
    };

    $.fn.loader = function (arg) {
        if (!$(this).size()) {
            return;
        }
        if ($.type(arg) === "string") {
            arg = {
                title: arg
            }
        }
        var dom = $(this);
        if (dom.size() > 1) {
            dom = dom.parent();
        }
        return $.loader_ext.init(dom, arg);
    };

})(jQuery);


